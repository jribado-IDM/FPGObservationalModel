Bootstrap: docker
From: rockylinux:9.2
Stage: spython-base

%files
# docker/pip.conf /root/.pip
# requirements.txt /tmp/

%post
# FROM docker-production.packages.idmod.org/dtk-rocky-buildenv:0.2-dev
# Replace the following lines with above line after the official image is available
#############################################################
# Set the timezone and the frontend
export TZ=UTC
export DEBIAN_FRONTEND=noninteractive

# To suppress warning without altering the installation when pip install with root user
export PIP_ROOT_USER_ACTION=ignore

# Install the necessary packages WITHOUT yum update
yum -y install \
    rpm \
    dnf-plugins-core \
    python3 \
    python3-pip \
    python3-devel \
    mpich \
    snappy \
    glibc-devel \
    epel-release \
    wget \
    nano

# Update the system
yum clean all

# Set timezone
ln -snf /usr/share/zoneinfo/$TZ /etc/localtime
echo $TZ > /etc/timezone

# Install pip
python3 -m pip install pip --upgrade

# Create a symbolic link to python3
ln -sf /usr/bin/python3 /usr/bin/python

# Set the path and library path
export PATH=${PATH}:/usr/lib64/mpich/bin
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/lib64/mpich/lib

# Add the requirements file

# make the PIP index configurable so we can build against staging, production, or a local PyPI server

# Install the ObsModel packages
# RUN bash -c "pip3 install -r /tmp/requirements.txt"
pip3 install --no-cache-dir "fpg-observational-model==1.0.0.dev2" --extra-index-url https://packages.idmod.org/api/pypi/pypi-production/simple

# Install the emod-api package
pip3 install --no-cache-dir "emod-api>=1.33.6,<2" --extra-index-url https://packages.idmod.org/api/pypi/pypi-production/simple

%environment
export TZ=UTC
export DEBIAN_FRONTEND=noninteractive
export PIP_ROOT_USER_ACTION=ignore
export PATH=${PATH}:/usr/lib64/mpich/bin
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/lib64/mpich/lib

%runscript
exec /bin/bash "$@"

%startscript
exec /bin/bash "$@"
